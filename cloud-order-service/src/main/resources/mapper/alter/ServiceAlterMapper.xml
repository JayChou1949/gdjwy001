<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hirisun.cloud.order.mapper.alter.ServiceAlterMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.hirisun.cloud.order.bean.alter.ServiceAlter">
        <id column="ID" property="id" />
        <result column="CREATE_TIME" property="createTime" />
        <result column="MODIFIED_TIME" property="modifiedTime" />
        <result column="CREATOR" property="creator" />
        <result column="API_PRODUCT_ID" property="apiProductId" />
        <result column="STATUS" property="status" />
        <result column="CREATOR_NAME" property="creatorName" />
        <result column="ORDER_NUMBER" property="orderNumber" />
        <result column="SERVICE_NAME" property="serviceName" />
        <result column="SERVICE_TYPE" property="serviceType" />
        <result column="IS_PUBLISH_APIG" property="isPublishApig" />
        <result column="IS_FROM_APP" property="isFromApp" />
        <result column="FROM_APP_NAME" property="fromAppName" />
        <result column="FROM_APP_ID" property="fromAppId" />
        <result column="AREA_NAME" property="areaName" />
        <result column="POLICE_CATEGORY" property="policeCategory" />
        <result column="CATEGORY" property="category" />
        <result column="PRIORITY_NAME" property="priorityName" />
        <result column="VENDOR" property="vendor" />
        <result column="REMARK" property="remark" />
        <result column="LOGO_URL" property="logoUrl" />
        <result column="TAG" property="tag" />
        <result column="WORK_FLOW_ID" property="workFlowId" />
        <result column="PROCESSING_PERSON" property="processingPerson" />
        <result column="WHERE_FROM" property="whereFrom" />
        <result column="JS_UNIT" property="jsUnit" />
        <result column="JS_PRINCIPAL" property="jsPrincipal" />
        <result column="JS_PRINCIPAL_PHONE" property="jsPrincipalPhone" />
        <result column="JS_MANAGER" property="jsManager" />
        <result column="JS_MANAGER_PHONE" property="jsManagerPhone" />
        <result column="CJ_UNIT" property="cjUnit" />
        <result column="CJ_PRINCIPAL" property="cjPrincipal" />
        <result column="CJ_PRINCIPAL_PHONE" property="cjPrincipalPhone" />
        <result column="CJ_HANDLER" property="cjHandler" />
        <result column="CJ_HANDLER_PHONE" property="cjHandlerPhone" />
        <result column="CJ_PRINCIPAL_IDCARD" property="cjPrincipalIdcard" />
        <result column="CJ_ORG_CODE" property="cjOrgCode" />
        <result column="CJ_INPUT_TYPE" property="cjInputType" />
        <result column="BUILD_MODE" property="buildMode" />
        <result column="UPDATE_CYCLE" property="updateCycle" />
        <result column="DATA_RESOURCE" property="dataResource" />
        <result column="DATA_FROM" property="dataFrom" />
        <result column="FROM_SYSTEM" property="fromSystem" />
        <result column="FROM_NET" property="fromNet" />
        <result column="COLLECTION_UNIT" property="collectionUnit" />
    </resultMap>

    <select id="getByActId" resultType="com.hirisun.cloud.order.bean.alter.ServiceAlter">
        select ai.ORDER_NUMBER from TB_SERVICE_ALTER ai left join TB_WFM_INSTANCE ins on ai.ID=ins.BUSINESSID
        left join TB_WFM_ACTIVITY act on act.INSTANCEID=ins.ID
        where act.ID = #{activityId}
    </select>

    <sql id="alterQuery">
        <choose>
            <when test="p.status == null or p.status == ''">
                AND ai.STATUS not in (-1,0)
            </when>
            <when test="p.status == 1">
                AND ai.STATUS in (1,7,101,102)
            </when>
            <when test="p.status == 5">
                AND ai.STATUS in (5,8)
            </when>
            <otherwise>
                AND ai.STATUS = #{p.status}
            </otherwise>
        </choose>
        <!-- 可以按申请人/申请单号查询 -->
        <if test="p.userName != null and p.userName != ''">
           and ai.CREATOR_NAME like #{p.userName}
        </if>
    </sql>

    <sql id="workbenchQuery">
        <choose>
            <!--全部状态除购物车-->
            <when test="p.queryVO.status == null or p.queryVO.status == ''">
                AND ai.STATUS not in (-1,0)
            </when>
            <!--待审核-->
            <when test="p.queryVO.status == 0">
                AND ai.STATUS in (1,7,101,102)
            </when>
            <!--待实施-->
            <when test="p.queryVO.status == 1">
                AND ai.STATUS = 2
            </when>
            <!--已驳回-->
            <when test="p.queryVO.status == 2">
                AND ai.STATUS in (5,6,8)
            </when>
            <!---删除或使用中-->
            <otherwise>
                AND ai.STATUS = #{p.queryVO.status}
            </otherwise>
        </choose>

        <!-- 申请单号查询 -->
        <if test="p.queryVO.keyWord != null and p.queryVO.keyWord != ''">
            AND ai.ORDER_NUMBER = #{p.queryVO.keyWord}
        </if>
    </sql>

    <select id="getPage" resultMap="BaseResultMap">
        SELECT distinct ai.*,ins.ID instanceId
        from TB_WFM_ACTIVITY act,TB_WFM_INSTANCE ins,TB_SERVICE_ALTER ai ,TB_WFM_WORKFLOWMODEL m
        <where>
            <include refid="alterQuery"/>
            and ai.ID=ins.BUSINESSID and act.INSTANCEID = ins.ID  and m.ID=act.MODELID and ai.ORDER_NUMBER IS NOT NULL
            <if test="(p.startDate != null and p.startDate != '') and (p.endDate != null and p.endDate != '')">
                AND TO_CHAR(ai.CREATE_TIME,'YYYY-MM-DD') &gt;= #{p.startDate}
                AND TO_CHAR(ai.CREATE_TIME,'YYYY-MM-DD') &lt;= #{p.endDate}
            </if>
            <!-- 选择处理人为:我 -->
            <if test="p.user.type != 100">
                and (act.HANDLEPERSONIDS =  #{p.user.idcard} or m.noticeperon like concat(concat('%', #{p.user.idcard}),'%') )
            </if>
            <!-- 选择处理人为:我 -->
            <if test="p.processType == 1">
                and act.HANDLEPERSONIDS =#{p.user.idcard}
                AND act.ACTIVITYSTATUS='待办' AND act.ACTIVITYTYPE is NULL
            </if>
            <!-- 选择处理人为:其他人 -->
            <if test="p.processType == 2">
                and  act.HANDLEPERSONIDS !=#{p.user.idcard}  AND act.ACTIVITYSTATUS='待办' AND act.ACTIVITYTYPE is NULL
            </if>
            <if test="p.orderNumber !=null and p.orderNumber !=''">
                and ai.ORDER_NUMBER like #{p.orderNumber}
            </if>
            <if test="p.serviceName !=null and p.serviceName !=''">
                and ai.SERVICE_NAME like #{p.serviceName}
            </if>
           and ai.WHERE_FROM='1'
        </where>
        ORDER BY ai.MODIFIED_TIME DESC
    </select>


    <select id="getPageBank" resultMap="BaseResultMap">
        SELECT distinct ai.*,(SELECT to_char(wm_concat(distinct U . NAME)) FROM TB_WFM_ACTIVITY act1,TB_USER U WHERE u.IDCARD=ACT1.HANDLEPERSONIDS AND ACT1.ACTIVITYSTATUS='待办' 	AND act1.INSTANCEID = ins. ID AND ACT1.ACTIVITYTYPE is NULL)  AS PROCESSING_PERSON
        from  TB_SERVICE_ALTER ai,TB_WFM_ACTIVITY act,TB_WFM_INSTANCE ins,TB_WFM_WORKFLOWMODEL m
        <where>
            <include refid="alterQuery"/>
            and ai.ID=ins.BUSINESSID and act.INSTANCEID = ins.ID  and m.ID=act.MODELID and ai.ORDER_NUMBER IS NOT NULL
            <if test="(p.startDate != null and p.startDate != '') and (p.endDate != null and p.endDate != '')">
                AND TO_CHAR(ai.CREATE_TIME,'YYYY-MM-DD') &gt;= #{p.startDate}
                AND TO_CHAR(ai.CREATE_TIME,'YYYY-MM-DD') &lt;= #{p.endDate}
            </if>
            <!-- 选择处理人为:我 -->
            <if test="p.user.type != 100">
                and (act.HANDLEPERSONIDS =  #{p.user.idcard} or m.noticeperon like concat(concat('%', #{p.user.idcard}),'%') )
            </if>
            <!-- 选择处理人为:我 -->
            <if test="p.processType == 1">
                and act.HANDLEPERSONIDS =#{p.user.idcard}
                AND act.ACTIVITYSTATUS='待办' AND act.ACTIVITYTYPE is NULL
            </if>
            <!-- 选择处理人为:其他人 -->
            <if test="p.processType == 2">
                and  act.HANDLEPERSONIDS !=#{p.user.idcard}  AND act.ACTIVITYSTATUS='待办' AND act.ACTIVITYTYPE is NULL
            </if>

        </where>
        ORDER BY ai.MODIFIED_TIME DESC
    </select>


    <select id="getWorkbenchApplyPage" resultMap="BaseResultMap">
        select r.*,p.PROCESSING_PERSON from (SELECT distinct ai.*
        from TB_WFM_ACTIVITY act,TB_WFM_INSTANCE ins,TB_SERVICE_ALTER ai ,TB_WFM_WORKFLOWMODEL m
        <where>
            <include refid="workbenchQuery"/>
            and ai.ID=ins.BUSINESSID and act.INSTANCEID = ins.ID  and m.ID=act.MODELID and ai.WHERE_FROM='1'
            <if test="(p.queryVO.startDate != null and p.queryVO.startDate != '') and (p.queryVO.endDate != null and p.queryVO.endDate != '')">
                AND TO_CHAR(ai.CREATE_TIME,'YYYY-MM-DD') &gt;= #{p.queryVO.startDate}
                AND TO_CHAR(ai.CREATE_TIME,'YYYY-MM-DD') &lt;= #{p.queryVO.endDate}
            </if>
            <!-- 选择处理人为:我 -->
            <if test="p.queryVO.processType == 1">
                and act.HANDLEPERSONIDS =#{p.queryVO.handler}
                AND act.ACTIVITYSTATUS='待办' AND act.ACTIVITYTYPE is NULL
            </if>
            <!-- 选择处理人为:其他人 -->
            <if test="p.queryVO.processType == 2">
                and  act.HANDLEPERSONIDS !=#{p.queryVO.handler}  AND act.ACTIVITYSTATUS='待办' AND act.ACTIVITYTYPE is NULL
            </if>
            <!--用户为警种租户管理员-->
            <if test="p.queryVO.policeCategory !=null and p.queryVO.policeCategory !=''">
                and  (ai.AREA_NAME = '省厅' or ai.AREA_NAME is null)
                and  ai.POLICE_CATEGORY like #{p.queryVO.policeCategory}
            </if>
            <!--用户为地市租户管理员-->
            <if test="p.queryVO.area !=null and p.queryVO.area !=''">
                and  ai.AREA_NAME = #{p.queryVO.area}
                and  ai.AREA_NAME != '省厅'
            </if>
            <!--用户为个人用户-->
            <if test="p.queryVO.creator !=null and p.queryVO.creator !=''">
                and  ai.CREATOR = #{p.queryVO.creator}
            </if>
            and ai.WHERE_FROM='1'

        </where>) r
        left join (select act.INSTANCEID,ins.BUSINESSID,to_char(wm_concat(distinct U . NAME)) AS PROCESSING_PERSON from TB_USER u,TB_WFM_ACTIVITY act,TB_WFM_INSTANCE ins  where u.IDCARD = act.HANDLEPERSONIDS  and ins.ID = act.INSTANCEID and act.ACTIVITYSTATUS='待办' and act.ACTIVITYTYPE is NULL group by act.INSTANCEID,ins.BUSINESSID) p ON p.BUSINESSID = r.ID
        ORDER BY r.MODIFIED_TIME DESC
</select>

    <select id="getWorkbenchApplyPageBank" resultMap="BaseResultMap">
        SELECT distinct ai.*,(SELECT to_char(wm_concat(distinct U . NAME)) FROM TB_WFM_ACTIVITY act1,TB_USER U WHERE u.IDCARD=ACT1.HANDLEPERSONIDS AND ACT1.ACTIVITYSTATUS='待办' 	AND act1.INSTANCEID = ins. ID AND ACT1.ACTIVITYTYPE is NULL)  AS PROCESSING_PERSON
        from  TB_SERVICE_ALTER ai,TB_WFM_ACTIVITY act,TB_WFM_INSTANCE ins,TB_WFM_WORKFLOWMODEL m
        <where>
            <include refid="workbenchQuery"/>
            and ai.ID=ins.BUSINESSID and act.INSTANCEID = ins.ID  and m.ID=act.MODELID and ai.WHERE_FROM='1'
            <if test="(p.queryVO.startDate != null and p.queryVO.startDate != '') and (p.queryVO.endDate != null and p.queryVO.endDate != '')">
                AND TO_CHAR(ai.CREATE_TIME,'YYYY-MM-DD') &gt;= #{p.queryVO.startDate}
                AND TO_CHAR(ai.CREATE_TIME,'YYYY-MM-DD') &lt;= #{p.queryVO.endDate}
            </if>
            <!-- 选择处理人为:我 -->
            <if test="p.queryVO.processType == 1">
                and act.HANDLEPERSONIDS =#{p.queryVO.handler}
                AND act.ACTIVITYSTATUS='待办' AND act.ACTIVITYTYPE is NULL
            </if>
            <!-- 选择处理人为:其他人 -->
            <if test="p.queryVO.processType == 2">
                and  act.HANDLEPERSONIDS !=#{p.queryVO.handler}  AND act.ACTIVITYSTATUS='待办' AND act.ACTIVITYTYPE is NULL
            </if>
            <!--用户为警种租户管理员-->
            <if test="p.queryVO.policeCategory !=null and p.queryVO.policeCategory !=''">
                and  (ai.AREA_NAME = '省厅' or ai.AREA_NAME is null)
                and  ai.POLICE_CATEGORY like #{p.queryVO.policeCategory}
            </if>
            <!--用户为地市租户管理员-->
            <if test="p.queryVO.area !=null and p.queryVO.area !=''">
                and  ai.AREA_NAME = #{p.queryVO.area}
                and  ai.AREA_NAME != '省厅'
            </if>
            <!--用户为个人用户-->
            <if test="p.queryVO.creator !=null and p.queryVO.creator !=''">
                and  ai.CREATOR = #{p.queryVO.creator}
            </if>

        </where>
        ORDER BY ai.MODIFIED_TIME DESC
    </select>


    <select id="getResourcePage" resultType="com.hirisun.cloud.model.workbench.vo.ResourceOverviewVO">
        select * from TB_SERVICE_ALTER where STATUS = 3 AND WHERE_FROM = 1
        <if test="p.queryVO.creator !=null and p.queryVO.creator !=''">
            and   CREATOR= #{p.queryVO.creator}
        </if>
        <if test="p.queryVO.keyWord !=null and p.queryVO.keyWord !=''">
            and  SERVICE_NAME like #{p.queryVO.keyWord}
        </if>
        <if test="p.queryVO.policeCategory !=null and p.queryVO.policeCategory !=''">
            and POLICE_CATEGORY like #{p.queryVO.policeCategory}
            and (AREA_NAME = '省厅' or AREA_NAME is null)
        </if>
        <if test="p.queryVO.area !=null and p.queryVO.area != ''">
            and AREA_NAME = #{p.queryVO.area}
        </if>

    </select>
    <select id="getPageFromMY" resultMap="BaseResultMap">
        SELECT tsp.* FROM TB_SERVICE_ALTER tsp
        <where>
            and tsp.WHERE_FROM='2' and tsp.SERVICE_TYPE = 'DAAS'
            <if test="(p.startDate != null and p.startDate != '') and (p.endDate != null and p.endDate != '')">
                AND TO_CHAR(tsp.CREATE_TIME,'YYYY-MM-DD') &gt;= #{p.startDate}
                AND TO_CHAR(tsp.CREATE_TIME,'YYYY-MM-DD') &lt;= #{p.endDate}
            </if>
            <if test="p.type != null and p.type != ''">
                and tsp.CATEGORY = #{p.type}
            </if>
            <if test="p.name != null and p.name != ''">
                and tsp.SERVICE_NAME  like #{p.name}
            </if>
            <choose>
                <when test="p.status == 8">
                    and tsp.STATUS = '8'
                </when>
                <otherwise>
                    and tsp.STATUS != '8' and tsp.STATUS != '4'
                </otherwise>
            </choose>
        </where>
    </select>

    <select id="getType" resultType="string">
        SELECT NAME FROM SYS_DICT WHERE ID = #{id}
    </select>

    <select id="getAlterTodoCount" resultType="java.lang.Integer">
        SELECT count(DISTINCT ai.ID)
        FROM TB_SERVICE_ALTER ai join TB_WFM_INSTANCE ins on ins.BUSINESSID = ai.ID
        join TB_WFM_ACTIVITY act  on act.INSTANCEID = ins.ID
        WHERE ai.STATUS in (1,2,7,101,102) and  ai.WHERE_FROM='1'
        <if test="user.idcard !=null and user.idcard !=''">
        and act.HANDLEPERSONIDS = #{user.idcard}
        </if>
        and act.ACTIVITYTYPE is null
        and act.ACTIVITYSTATUS = '待办'
    </select>

    <select id="getAlterTodo" resultType="java.lang.Integer">
        SELECT count(DISTINCT ai.ID)
        FROM TB_SERVICE_ALTER ai join TB_WFM_INSTANCE ins on ins.BUSINESSID = ai.ID
        join TB_WFM_ACTIVITY act  on act.INSTANCEID = ins.ID
        WHERE ai.STATUS in (1,2,7,101,102) and  ai.WHERE_FROM='1'
        <if test="idCard !=null and idCard !=''">
            and act.HANDLEPERSONIDS = #{idCard}
        </if>
        and act.ACTIVITYTYPE is null
        and act.ACTIVITYSTATUS = '待办'
    </select>

    <select id="getReviewCount" resultType="java.lang.Integer">
        SELECT count(DISTINCT ai.ID)
        FROM TB_SERVICE_ALTER ai join TB_WFM_INSTANCE ins on ins.BUSINESSID = ai.ID join TB_WFM_ACTIVITY act  on act.INSTANCEID = ins.ID
        WHERE ai.STATUS in (1,7,101,102) and ai.WHERE_FROM='1'
        <if test="p.queryVO.policeCategory !=null and p.queryVO.policeCategory !=''">
            and  ai.POLICE_CATEGORY = #{p.queryVO.policeCategory}
        </if>
        <if test="p.queryVO.area !=null and p.queryVO.area !=''">
            and  ai.AREA_NAME = #{p.queryVO.area}
        </if>
        <if test="p.queryVO.creator !=null and p.queryVO.creator !=''">
            and ai.CREATOR = #{p.queryVO.creator}
        </if>
        and act.ACTIVITYTYPE is null and act.ACTIVITYSTATUS = '待办'
    </select>

    <select id="getImplCount" resultType="java.lang.Integer">
        SELECT count(DISTINCT ai.ID)
        FROM TB_SERVICE_ALTER ai join TB_WFM_INSTANCE ins on ins.BUSINESSID = ai.ID join TB_WFM_ACTIVITY act  on act.INSTANCEID = ins.ID
        WHERE ai.STATUS = 2 and ai.WHERE_FROM='1'
        <if test="p.queryVO.policeCategory !=null and p.queryVO.policeCategory !=''">
            and  ai.POLICE_CATEGORY = #{p.queryVO.policeCategory}
        </if>
        <if test="p.queryVO.area !=null and p.queryVO.area !=''">
            and  ai.AREA_NAME = #{p.queryVO.area}
        </if>
        <if test="p.queryVO.creator !=null and p.queryVO.creator !=''">
            and ai.CREATOR = #{p.queryVO.creator}
        </if>
        and act.ACTIVITYTYPE is null and act.ACTIVITYSTATUS = '待办'
    </select>

    <select id="getRejectCount" resultType="java.lang.Integer">
        select count(*) from TB_SERVICE_ALTER a where a.STATUS in (5,6,8) and a.WHERE_FROM='1'
        <if test="p.queryVO.policeCategory !=null and p.queryVO.policeCategory !=''">
            and  a.POLICE_CATEGORY like #{p.queryVO.policeCategory}
            and  (a.AREA_NAME = '省厅' or a.AREA_NAME is null)
        </if>
        <if test="p.queryVO.area !=null and p.queryVO.area !=''">
            and  a.AREA_NAME = #{p.queryVO.area}
            and  a.AREA_NAME != '省厅'
        </if>
        <if test="p.queryVO.creator !=null and p.queryVO.creator !=''">
            and a.CREATOR = #{p.queryVO.creator}
        </if>
    </select>

    <select id="getUseCount" resultType="java.lang.Integer">
        select count(*) from TB_SERVICE_ALTER a where a.STATUS = 3 and a.WHERE_FROM='1'
        <if test="p.queryVO.policeCategory !=null and p.queryVO.policeCategory !=''">
            and  a.POLICE_CATEGORY like #{p.queryVO.policeCategory}
            and  (a.AREA_NAME = '省厅' or a.AREA_NAME is null)
        </if>
        <if test="p.queryVO.area !=null and p.queryVO.area !=''">
            and  a.AREA_NAME = #{p.queryVO.area}
            and  a.AREA_NAME != '省厅'
        </if>
        <if test="p.queryVO.creator !=null and p.queryVO.creator !=''">
            and a.CREATOR = #{p.queryVO.creator}
        </if>
    </select>
    
</mapper>
